================================================================================
                    عملية: إرجاع بضاعة من المسوق إلى المخزن
================================================================================

📋 نظرة عامة:
--------------
عملية إرجاع المسوق للبضاعة إلى المخزن الرئيسي تمر بعدة مراحل من الإنشاء حتى التوثيق النهائي.
✅ البضاعة تنتقل مباشرة من المسوق إلى المخزن الرئيسي عند التوثيق (بدون مرور على المحجوز).

================================================================================
                        🗂️ الجداول المستخدمة
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│ 1️⃣ marketer_return_requests                                                 │
└─────────────────────────────────────────────────────────────────────────────┘

وظيفته:
يمثل طلب إرجاع بضاعة من المسوق إلى المخزن الرئيسي، من لحظة الإنشاء إلى التوثيق النهائي.

الحقل              النوع        العلاقة           القيمة الافتراضية    الوصف
──────────────────────────────────────────────────────────────────────────────────────
id                 BIGINT       PK               AUTO_INCREMENT        المعرف الداخلي
invoice_number     VARCHAR      UNIQUE           —                     رقم فاتورة الإرجاع
marketer_id        BIGINT       FK → users.id    —                     المسوق منشئ الطلب
status             ENUM         —                'pending'             pending / approved / rejected / cancelled / documented
notes              TEXT         —                NULL                  سبب الرفض أو ملاحظات
approved_by        BIGINT       FK → users.id    NULL                  أمين المخزن الذي وافق
approved_at        TIMESTAMP    —                NULL                  تاريخ الموافقة
rejected_by        BIGINT       FK → users.id    NULL                  أمين المخزن الذي رفض
rejected_at        TIMESTAMP    —                NULL                  تاريخ الرفض
documented_by      BIGINT       FK → users.id    NULL                  أمين المخزن الذي وثّق
documented_at      TIMESTAMP    —                NULL                  تاريخ التوثيق النهائي
stamped_image      VARCHAR      —                NULL                  صورة الفاتورة المختومة
created_at         TIMESTAMP    —                CURRENT_TIMESTAMP     تاريخ إنشاء الطلب
updated_at         TIMESTAMP    —                CURRENT_TIMESTAMP     آخر تغيير حالة


┌─────────────────────────────────────────────────────────────────────────────┐
│ 2️⃣ marketer_return_items                                                    │
└─────────────────────────────────────────────────────────────────────────────┘

وظيفته:
يحتوي على تفاصيل المنتجات والكميات المرجعة في كل طلب إرجاع.

الحقل              النوع        العلاقة                             الوصف
─────────────────────────────────────────────────────────────────────────────
id                 BIGINT       PK                                 المعرف الداخلي
return_request_id  BIGINT       FK → marketer_return_requests.id   معرف طلب الإرجاع
product_id         BIGINT       FK → products.id                   معرف المنتج
quantity           INT          —                                  الكمية المرجعة


================================================================================
                        المراحل والجداول المتأثرة
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│ المرحلة 1: إنشاء طلب الإرجاع (Pending)                                     │
└─────────────────────────────────────────────────────────────────────────────┘

🔹 الفاعل: المسوق (Salesman/Marketer)
🔹 الشرط: يجب أن تكون البضاعة موجودة في marketer_actual_stock

📊 الجداول المتأثرة:
--------------------

1️⃣ marketer_return_requests
   - يتم إنشاء سجل جديد
   - الحقول المستخدمة:
     • id (تلقائي)
     • invoice_number (رقم فاتورة الإرجاع)
     • marketer_id (معرف المسوق)
     • status = 'pending'
     • created_at (وقت الإنشاء)

2️⃣ marketer_return_items
   - يتم إضافة سجل لكل منتج في الإرجاع
   - الحقول المستخدمة:
     • id (تلقائي)
     • return_request_id (FK → marketer_return_requests.id)
     • product_id (FK → products.id)
     • quantity (الكمية المرجعة)

📌 ملاحظة: في هذه المرحلة لا يتأثر المخزون، مجرد تسجيل الطلب


┌─────────────────────────────────────────────────────────────────────────────┐
│ المرحلة 2: موافقة أمين المخزن (Approved)                                   │
└─────────────────────────────────────────────────────────────────────────────┘

🔹 الفاعل: أمين المخزن (Warehouse Keeper)
🔹 الشرط: التحقق من أن الكمية موجودة في مخزون المسوق الفعلي

📊 الجداول المتأثرة:
--------------------

1️⃣ marketer_return_requests
   - تحديث السجل الموجود
   - الحقول المحدثة:
     • status = 'approved'
     • approved_by (FK → users.id) - معرف أمين المخزن
     • approved_at (وقت الموافقة)
     • updated_at

📌 ملاحظة: في هذه المرحلة لا يتأثر المخزون، فقط الموافقة المبدئية


┌─────────────────────────────────────────────────────────────────────────────┐
│ المرحلة 3: رفض أمين المخزن (Rejected) - احتمال بديل                        │
└─────────────────────────────────────────────────────────────────────────────┘

🔹 الفاعل: أمين المخزن (Warehouse Keeper)

⚠️ الرفض له حالتان:

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔴 الحالة 1: رفض من pending → rejected
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 الجداول المتأثرة:

1️⃣ marketer_return_requests
   - تحديث السجل الموجود
   - الحقول المحدثة:
     • status = 'rejected'
     • rejected_by (FK → users.id)
     • rejected_at
     • notes (سبب الرفض)
     • updated_at

📌 ملاحظة: لا يتأثر المخزون، البضاعة تبقى مع المسوق


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔴 الحالة 2: رفض من approved → rejected
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 الجداول المتأثرة:

1️⃣ marketer_return_requests
   - تحديث السجل الموجود
   - الحقول المحدثة:
     • status = 'rejected'
     • rejected_by (FK → users.id)
     • rejected_at
     • notes (سبب الرفض)
     • updated_at

📌 ملاحظة: لا يتأثر المخزون، البضاعة تبقى مع المسوق


┌─────────────────────────────────────────────────────────────────────────────┐
│ المرحلة 4: إلغاء المسوق (Cancelled) - احتمال بديل                          │
└─────────────────────────────────────────────────────────────────────────────┘

🔹 الفاعل: المسوق (Salesman/Marketer)

⚠️ الإلغاء له حالتان:

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🟡 الحالة 1: إلغاء من pending → cancelled
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 الجداول المتأثرة:

1️⃣ marketer_return_requests
   - تحديث السجل الموجود
   - الحقول المحدثة:
     • status = 'cancelled'
     • notes (سبب الإلغاء)
     • updated_at

📌 ملاحظة: لا يتأثر المخزون


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🟡 الحالة 2: إلغاء من approved → cancelled
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 الجداول المتأثرة:

1️⃣ marketer_return_requests
   - تحديث السجل الموجود
   - الحقول المحدثة:
     • status = 'cancelled'
     • notes (سبب الإلغاء)
     • updated_at

📌 ملاحظة: لا يتأثر المخزون


┌─────────────────────────────────────────────────────────────────────────────┐
│ المرحلة 5: التوثيق النهائي (Documented)                                    │
└─────────────────────────────────────────────────────────────────────────────┘

🔹 الفاعل: أمين المخزن (Warehouse Keeper)
🔹 الشرط: يجب أن تكون الحالة 'approved'

📊 الجداول المتأثرة:
--------------------

1️⃣ marketer_return_requests
   - تحديث السجل الموجود
   - الحقول المحدثة:
     • status = 'documented'
     • documented_by (FK → users.id) - أمين المخزن
     • documented_at (وقت التوثيق)
     • stamped_image (صورة الفاتورة المختومة)
     • updated_at

2️⃣ marketer_actual_stock
   - ✅ خصم من المخزون الفعلي للمسوق
   - الحقول المحدثة:
     • quantity = quantity - الكمية_المرجعة (لكل منتج)

3️⃣ main_stock
   - ✅ إضافة إلى المخزن الرئيسي مباشرة
   - الحقول المحدثة:
     • quantity = quantity + الكمية_المرجعة (لكل منتج)
     • updated_at (وقت التحديث)

4️⃣ warehouse_stock_logs
   - تسجيل حركة المخزن
   - الحقول المستخدمة:
     • id (تلقائي)
     • invoice_type = 'marketer_return'
     • invoice_id (معرف طلب الإرجاع)
     • keeper_id (FK → users.id)
     • action = 'return'
     • created_at

📌 ملاحظة: البضاعة تنتقل مباشرة من المسوق إلى المخزن الرئيسي (بدون مرور على المحجوز)


================================================================================
                            ملخص الجداول المتأثرة
================================================================================

✅ جداول أساسية (تتأثر في كل الحالات):
   1. marketer_return_requests
   2. marketer_return_items

✅ جداول المخزون (تتأثر عند التوثيق فقط):
   3. marketer_actual_stock (خصم)
   4. main_stock (إضافة مباشرة)
   5. warehouse_stock_logs

✅ جداول مرجعية (للقراءة فقط):
   - users (للمسوق وأمين المخزن)
   - products (لمعلومات المنتجات)


================================================================================
                        مخطط تدفق الحالات (Status Flow)
================================================================================

                            ┌─────────────┐
                            │   pending   │ ← إنشاء طلب الإرجاع
                            └──────┬──────┘
                                   │
                    ┌──────────────┼──────────────┐
                    │              │              │
                    ▼              ▼              ▼
              ┌──────────┐   ┌──────────┐   ┌──────────┐
              │cancelled │   │ approved │   │ rejected │
              │          │   │          │   │          │
              └──────────┘   └─────┬────┘   └──────────┘
                                   │
            ┌─────────┼────────────┬───────────────────┐
            │                      │                   │
            ▼                      ▼                   ▼
     ┌─────────────┐       ┌─────────────┐       ┌──────────┐
     │  rejected   │       │ documented  │       │cancelled │
     │             │       │ فعلي→رئيسي │       │          │
     └─────────────┘       └─────────────┘       └──────────┘


================================================================================
                        🔄 حركة المخزون في كل مرحلة
================================================================================

📦 عند الإنشاء (pending):
   لا تغيير في المخزون

📦 عند الموافقة (approved):
   لا تغيير في المخزون

📦 عند الرفض (rejected):
   لا تغيير في المخزون (البضاعة تبقى مع المسوق)

📦 عند الإلغاء (cancelled):
   لا تغيير في المخزون

📦 عند التوثيق (documented):
   marketer_actual_stock ↓
   main_stock ↑ (مباشرة بدون مرور على المحجوز)


================================================================================
                        مخطط حركة البضاعة
================================================================================

    ┌──────────────────────┐
    │ marketer_actual_stock│ ← البضاعة عند المسوق
    └──────────┬───────────┘
               │
               │ (عند التوثيق - documented)
               │ (بعد رفع الفاتورة المختومة)
               │ ❌ لا تمر على marketer_reserved_stock
               │
               ▼
    ┌──────────────────────┐
    │     main_stock       │ ← البضاعة تعود للمخزن الرئيسي مباشرة
    └──────────────────────┘


================================================================================
                            ملاحظات مهمة
================================================================================

⚠️ قواعد العمل:
   1. ✅ لا يمكن إرجاع كمية أكبر من الموجودة في marketer_actual_stock
   2. ✅ لا يمكن إلغاء طلب الإرجاع بعد التوثيق (documented)
   3. ✅ يجب رفع صورة الفاتورة المختومة عند التوثيق
   4. ✅ البضاعة لا تتحرك إلا عند التوثيق (documented)
   5. ✅ البضاعة تنتقل مباشرة: marketer_actual_stock → main_stock
   6. ✅ لا يوجد مخزون محجوز في عملية الإرجاع
   7. ✅ عند الرفض/الإلغاء: لا يتأثر المخزون (البضاعة تبقى مع المسوق)

🔐 الصلاحيات:
   - المسوق: إنشاء طلب الإرجاع، الإلغاء (pending أو approved)
   - أمين المخزن: الموافقة، الرفض، التوثيق النهائي

📊 التقارير المتاحة:
   - طلبات الإرجاع حسب الحالة
   - حركة المخزون (إرجاعات)
   - مخزون المسوق بعد الإرجاع
   - سجل التوثيقات

🎯 الفرق الرئيسي عن طلب البضاعة:
   - ✅ طلب البضاعة: main_stock → reserved → actual
   - ✅ إرجاع البضاعة: actual → main_stock (مباشرة)

💡 حالات الاستخدام:
   - بضاعة زائدة عن حاجة المسوق
   - بضاعة قريبة من انتهاء الصلاحية
   - بضاعة بها عيوب تصنيع
   - إعادة توزيع البضاعة بين المسوقين

================================================================================
