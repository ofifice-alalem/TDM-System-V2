================================================================================
                    عملية: بيع بضاعة من المسوق إلى المتجر
================================================================================

📋 نظرة عامة:
--------------
عملية بيع المسوق للبضاعة إلى المتجر تمر بمرحلتين: إنشاء الفاتورة ثم التوثيق النهائي.
✅ البضاعة تنتقل من المسوق إلى المتجر عبر مخزون مرحلي (pending).
✅ الدين يُسجل فقط عند التوثيق النهائي.

================================================================================
                        🗂️ الجداول المستخدمة
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│ 1️⃣ sales_invoices                                                           │
└─────────────────────────────────────────────────────────────────────────────┘

وظيفته:
يمثل فاتورة بيع من المسوق إلى المتجر، من لحظة الإنشاء إلى التوثيق النهائي.

الحقل                    النوع        العلاقة           القيمة الافتراضية    الوصف
────────────────────────────────────────────────────────────────────────────────────────────
id                       BIGINT       PK               AUTO_INCREMENT        المعرف الداخلي
invoice_number           VARCHAR      UNIQUE           —                     رقم الفاتورة
marketer_id              BIGINT       FK → users.id    —                     المسوق البائع
store_id                 BIGINT       FK → stores.id   —                     المتجر المشتري
total_amount             DECIMAL      —                —                     المبلغ الإجمالي النهائي
subtotal                 DECIMAL      —                —                     المجموع الفرعي
product_discount         DECIMAL      —                0.00                  خصم المنتجات (من العروض)
invoice_discount_type    ENUM         —                NULL                  percentage / fixed
invoice_discount_value   DECIMAL      —                NULL                  قيمة الخصم
invoice_discount_amount  DECIMAL      —                0.00                  مبلغ الخصم
status                   ENUM         —                'pending'             pending / approved / cancelled
keeper_id                BIGINT       FK → users.id    NULL                  أمين المخزن الموثق
stamped_invoice_image    VARCHAR      —                NULL                  صورة الفاتورة المختومة
confirmed_at             TIMESTAMP    —                NULL                  تاريخ التوثيق
notes                    TEXT         —                NULL                  ملاحظات
created_at               TIMESTAMP    —                CURRENT_TIMESTAMP     تاريخ الإنشاء
updated_at               TIMESTAMP    —                CURRENT_TIMESTAMP     آخر تحديث


┌─────────────────────────────────────────────────────────────────────────────┐
│ 2️⃣ sales_invoice_items                                                      │
└─────────────────────────────────────────────────────────────────────────────┘

وظيفته:
يحتوي على تفاصيل المنتجات والكميات والأسعار في كل فاتورة بيع.

الحقل              النوع        العلاقة                          الوصف
─────────────────────────────────────────────────────────────────────────────────
id                 BIGINT       PK                              المعرف الداخلي
invoice_id         BIGINT       FK → sales_invoices.id          معرف الفاتورة
product_id         BIGINT       FK → products.id                معرف المنتج
quantity           INT          —                               الكمية المباعة
free_quantity      INT          —                               الكمية المجانية (من العروض)
unit_price         DECIMAL      —                               سعر الوحدة وقت البيع
total_price        DECIMAL      —                               السعر الإجمالي
promotion_id       BIGINT       FK → product_promotions.id      معرف العرض (إن وجد)


================================================================================
                        المراحل والجداول المتأثرة
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│ المرحلة 1: إنشاء فاتورة البيع (Pending)                                   │
└─────────────────────────────────────────────────────────────────────────────┘

🔹 الفاعل: المسوق (Salesman/Marketer)
🔹 الشرط: يجب أن تكون البضاعة موجودة في marketer_actual_stock

📊 الجداول المتأثرة:
--------------------

1️⃣ sales_invoices
   - يتم إنشاء سجل جديد
   - الحقول المستخدمة:
     • id (تلقائي)
     • invoice_number (رقم الفاتورة)
     • marketer_id (معرف المسوق)
     • store_id (معرف المتجر)
     • total_amount (المبلغ الإجمالي)
     • subtotal (المجموع الفرعي)
     • product_discount (خصم المنتجات)
     • invoice_discount_type (نوع خصم الفاتورة)
     • invoice_discount_value (قيمة الخصم)
     • invoice_discount_amount (مبلغ الخصم)
     • status = 'pending'
     • notes (ملاحظات)
     • created_at (وقت الإنشاء)

2️⃣ sales_invoice_items
   - يتم إضافة سجل لكل منتج في الفاتورة
   - الحقول المستخدمة:
     • id (تلقائي)
     • invoice_id (FK → sales_invoices.id)
     • product_id (FK → products.id)
     • quantity (الكمية المباعة)
     • free_quantity (الكمية المجانية)
     • unit_price (سعر الوحدة وقت البيع)
     • total_price (السعر الإجمالي)
     • promotion_id (معرف العرض إن وجد)

3️⃣ marketer_actual_stock
   - ✅ خصم من المخزون الفعلي للمسوق
   - الحقول المحدثة:
     • quantity = quantity - (الكمية_المباعة + الكمية_المجانية)

4️⃣ store_pending_stock
   - ✅ إضافة إلى المخزون المرحلي للمتجر
   - الحقول المستخدمة:
     • id (تلقائي)
     • store_id (FK → stores.id)
     • sales_invoice_id (FK → sales_invoices.id)
     • product_id (FK → products.id)
     • quantity (الكمية_المباعة + الكمية_المجانية)
     • created_at

📌 ملاحظة: البضاعة تنتقل من المسوق إلى المخزون المرحلي، لا يُسجل دين بعد


┌─────────────────────────────────────────────────────────────────────────────┐
│ المرحلة 2: إلغاء الفاتورة (Cancelled) - احتمال بديل                        │
└─────────────────────────────────────────────────────────────────────────────┘

🔹 الفاعل: المسوق (Salesman/Marketer)
🔹 الشرط: يمكن الإلغاء فقط إذا كانت الحالة 'pending'

📊 الجداول المتأثرة:
--------------------

1️⃣ sales_invoices
   - تحديث السجل الموجود
   - الحقول المحدثة:
     • status = 'cancelled'
     • updated_at

2️⃣ marketer_actual_stock
   - ✅ إرجاع إلى المخزون الفعلي للمسوق
   - الحقول المحدثة:
     • quantity = quantity + (الكمية_المباعة + الكمية_المجانية)

3️⃣ store_pending_stock
   - ✅ حذف السجلات المرتبطة بهذه الفاتورة
   - WHERE sales_invoice_id = معرف_الفاتورة

📌 ملاحظة: البضاعة تعود من المخزون المرحلي إلى المسوق


┌─────────────────────────────────────────────────────────────────────────────┐
│ المرحلة 3: التوثيق النهائي (Approved)                                      │
└─────────────────────────────────────────────────────────────────────────────┘

🔹 الفاعل: أمين المخزن (Warehouse Keeper)
🔹 الشرط: يجب أن تكون الحالة 'pending' ورفع الفاتورة المختومة

📊 الجداول المتأثرة:
--------------------

1️⃣ sales_invoices
   - تحديث السجل الموجود
   - الحقول المحدثة:
     • status = 'approved'
     • keeper_id (FK → users.id) - أمين المخزن
     • stamped_invoice_image (صورة الفاتورة المختومة)
     • confirmed_at (وقت التوثيق)
     • updated_at

2️⃣ store_pending_stock
   - ✅ حذف السجلات المرتبطة بهذه الفاتورة
   - WHERE sales_invoice_id = معرف_الفاتورة

3️⃣ store_actual_stock
   - ✅ إضافة إلى المخزون الفعلي للمتجر
   - الحقول المستخدمة:
     • id (تلقائي إذا كان سجل جديد)
     • store_id (FK → stores.id)
     • product_id (FK → products.id)
     • quantity = quantity + (الكمية_المباعة + الكمية_المجانية)

4️⃣ store_debt_ledger
   - ✅ تسجيل الدين على المتجر
   - الحقول المستخدمة:
     • id (تلقائي)
     • store_id (FK → stores.id)
     • entry_type = 'sale'
     • sales_invoice_id (FK → sales_invoices.id)
     • return_id (NULL)
     • payment_id (NULL)
     • amount (المبلغ الإجمالي - موجب)
     • created_at

📌 ملاحظة: البضاعة تنتقل من المرحلي إلى الفعلي، ويُسجل الدين


================================================================================
                            ملخص الجداول المتأثرة
================================================================================

✅ جداول أساسية (تتأثر في كل الحالات):
   1. sales_invoices
   2. sales_invoice_items

✅ جداول المخزون (تتأثر عند الإنشاء):
   3. marketer_actual_stock (خصم)
   4. store_pending_stock (إضافة)

✅ جداول المخزون (تتأثر عند التوثيق):
   5. store_pending_stock (حذف)
   6. store_actual_stock (إضافة)

✅ جداول الديون (تتأثر عند التوثيق فقط):
   7. store_debt_ledger

✅ جداول مرجعية (للقراءة فقط):
   - users (للمسوق وأمين المخزن)
   - stores (لمعلومات المتجر)
   - products (لمعلومات المنتجات والأسعار)
   - product_promotions (للعروض الترويجية - هدايا)
   - invoice_discount_tiers (لخصومات الفواتير التلقائية)


================================================================================
                        مخطط تدفق الحالات (Status Flow)
================================================================================

                            ┌─────────────┐
                            │   pending   │ ← إنشاء فاتورة البيع
                            └──────┬──────┘
                                   │
                         ┌─────────┴─────────┐
                         │                   │
                         ▼                   ▼
                   ┌──────────┐        ┌──────────┐
                   | approved │        │cancelled │
                   │+ إرجاع  │        │   + دين  │
                   └──────────┘        └──────────┘


================================================================================
                        🔄 حركة المخزون في كل مرحلة
================================================================================

📦 عند الإنشاء (pending):
   marketer_actual_stock ↓
   store_pending_stock ↑

📦 عند الإلغاء (cancelled):
   marketer_actual_stock ↑
   store_pending_stock ↓ (حذف)

📦 عند التوثيق (approved):
   store_pending_stock ↓ (حذف)
   store_actual_stock ↑
   store_debt_ledger ↑ (تسجيل الدين)


================================================================================
                        مخطط حركة البضاعة والدين
================================================================================

    ┌──────────────────────┐
    │ marketer_actual_stock│ ← البضاعة عند المسوق
    └──────────┬───────────┘
               │
               │ (عند الإنشاء - pending)
               │
               ▼
    ┌──────────────────────┐
    │ store_pending_stock  │ ← المخزون المرحلي للمتجر
    └──────────┬───────────┘
               │
               │ (عند التوثيق - approved)
               │ (بعد رفع الفاتورة المختومة)
               │
               ▼
    ┌──────────────────────┐
    │  store_actual_stock  │ ← المخزون الفعلي للمتجر
    └──────────────────────┘

               +

    ┌──────────────────────┐
    │  store_debt_ledger   │ ← تسجيل الدين على المتجر
    └──────────────────────┘


================================================================================
                            ملاحظات مهمة
================================================================================

⚠️ قواعد العمل:
   1. ✅ لا يمكن البيع بكمية أكبر من الموجودة في marketer_actual_stock
   2. ✅ يمكن إلغاء الفاتورة فقط في حالة pending
   3. ✅ عند الإلغاء: البضاعة تعود من store_pending_stock → marketer_actual_stock
   4. ✅ يجب رفع صورة الفاتورة المختومة من المتجر عند التوثيق
   5. ✅ البضاعة تتحرك على مرحلتين:
      - عند الإنشاء: marketer_actual_stock → store_pending_stock
      - عند التوثيق: store_pending_stock → store_actual_stock
   6. ✅ الدين يُسجل فقط عند التوثيق (approved)
   7. ✅ السعر المسجل هو السعر وقت البيع (unit_price)
   8. ✅ يتم احتساب العروض الترويجية (الكمية المجانية) عند الإنشاء

🔐 الصلاحيات:
   - المسوق: إنشاء فاتورة البيع، الإلغاء (pending فقط)
   - أمين المخزن: التوثيق النهائي بعد رفع الفاتورة المختومة

📊 التقارير المتاحة:
   - فواتير البيع حسب الحالة
   - مبيعات المسوق
   - ديون المتاجر
   - حركة مخزون المسوق
   - حركة مخزون المتجر

💰 حساب الدين:
   - الدين = total_amount (بعد كل الخصومات)
   - الدين يُسجل فقط عند التوثيق (approved)
   - الدين الكلي للمتجر = مجموع (sale) - مجموع (return) - مجموع (payment)

🎁 العروض الترويجية:
   - يتم التحقق من product_promotions عند إنشاء الفاتورة
   - إذا كانت الكمية >= min_quantity، يتم إضافة free_quantity
   - الكمية المجانية تُخصم من مخزون المسوق أيضاً
   - الكمية المجانية لا تُحسب في السعر

💵 الخصومات:
   - خصم المنتج: يُطبق على مستوى المنتج (من العروض)
   - خصم الفاتورة: يُطبق على إجمالي الفاتورة
   - أنواع خصم الفاتورة: نسبة مئوية (percentage) أو مبلغ ثابت (fixed)

================================================================================
