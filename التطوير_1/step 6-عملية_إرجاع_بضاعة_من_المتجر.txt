================================================================================
                    عملية: إرجاع بضاعة من المتجر إلى المسوق
================================================================================

📋 نظرة عامة:
--------------
عملية إرجاع المتجر للبضاعة إلى المسوق تمر بمرحلتين: إنشاء طلب الإرجاع ثم التوثيق النهائي.
✅ البضاعة تعود من مخزون المتجر الفعلي إلى مخزون المسوق الفعلي عبر مخزون مرحلي.
✅ الدين يُخصم فقط عند التوثيق النهائي.
⚠️ ملاحظة مهمة: لا تتأثر عمولات المسوق بالإرجاع، العمولات تتأثر فقط بإيصالات القبض.

================================================================================
                        🗂️ الجداول المستخدمة
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│ 1️⃣ sales_returns                                                            │
└─────────────────────────────────────────────────────────────────────────────┘

وظيفته:
يمثل طلب إرجاع بضاعة من المتجر إلى المسوق، من لحظة الإنشاء إلى التوثيق النهائي.

الحقل                النوع        العلاقة                القيمة الافتراضية    الوصف
────────────────────────────────────────────────────────────────────────────────────────
id                   BIGINT       PK                    AUTO_INCREMENT        المعرف الداخلي
return_number        VARCHAR      UNIQUE                —                     رقم فاتورة الإرجاع
sales_invoice_id     BIGINT       FK → sales_invoices.id —                    الفاتورة الأصلية
store_id             BIGINT       FK → stores.id        —                     المتجر
marketer_id          BIGINT       FK → users.id         —                     المسوق
total_amount         DECIMAL      —                     —                     المبلغ الإجمالي للإرجاع
status               ENUM         —                     'pending'             pending / approved / rejected / cancelled
keeper_id            BIGINT       FK → users.id         NULL                  أمين المخزن الموثق
stamped_image        VARCHAR      —                     NULL                  صورة فاتورة الإرجاع المختومة
confirmed_at         TIMESTAMP    —                     NULL                  تاريخ التوثيق
notes                TEXT         —                     NULL                  ملاحظات (سبب الرفض أو الإلغاء)
created_at           TIMESTAMP    —                     CURRENT_TIMESTAMP     تاريخ الإنشاء
updated_at           TIMESTAMP    —                     CURRENT_TIMESTAMP     آخر تحديث


┌─────────────────────────────────────────────────────────────────────────────┐
│ 2️⃣ sales_return_items                                                       │
└─────────────────────────────────────────────────────────────────────────────┘

وظيفته:
يحتوي على تفاصيل المنتجات والكميات المرجعة في كل طلب إرجاع.

الحقل                    النوع        العلاقة                          الوصف
─────────────────────────────────────────────────────────────────────────────────
id                       BIGINT       PK                              المعرف الداخلي
return_id                BIGINT       FK → sales_returns.id           معرف طلب الإرجاع
sales_invoice_item_id    BIGINT       FK → sales_invoice_items.id     البند الأصلي من الفاتورة
product_id               BIGINT       FK → products.id                معرف المنتج
quantity                 INT          —                               الكمية المرجعة
unit_price               DECIMAL      —                               السعر من الفاتورة الأصلية


┌─────────────────────────────────────────────────────────────────────────────┐
│ 3️⃣ store_return_pending_stock                                               │
└─────────────────────────────────────────────────────────────────────────────┘

وظيفته:
يحتوي على البضاعة المرجعة قيد المعالجة (بين المتجر والمسوق).

الحقل              النوع        العلاقة                    الوصف
─────────────────────────────────────────────────────────────────────────────────
id                 BIGINT       PK                        المعرف الداخلي
return_id          BIGINT       FK → sales_returns.id     معرف طلب الإرجاع
store_id           BIGINT       FK → stores.id            معرف المتجر
product_id         BIGINT       FK → products.id          معرف المنتج
quantity           INT          —                         الكمية المرجعة
created_at         TIMESTAMP    —                         وقت الإنشاء


================================================================================
                        المراحل والجداول المتأثرة
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│ المرحلة 1: إنشاء طلب الإرجاع (Pending)                                     │
└─────────────────────────────────────────────────────────────────────────────┘

🔹 الفاعل: المسوق (Salesman/Marketer)
🔹 الشرط: يجب أن تكون البضاعة من فاتورة بيع موثقة سابقاً (approved)

📊 الجداول المتأثرة:
--------------------

1️⃣ sales_returns
   - يتم إنشاء سجل جديد
   - الحقول المستخدمة:
     • id (تلقائي)
     • return_number (رقم فاتورة الإرجاع)
     • sales_invoice_id (FK → sales_invoices.id) - الفاتورة الأصلية
     • store_id (FK → stores.id) - معرف المتجر
     • marketer_id (FK → users.id) - معرف المسوق
     • total_amount (المبلغ الإجمالي للإرجاع)
     • status = 'pending'
     • created_at (وقت الإنشاء)

2️⃣ sales_return_items
   - يتم إضافة سجل لكل منتج في الإرجاع
   - الحقول المستخدمة:
     • id (تلقائي)
     • return_id (FK → sales_returns.id)
     • sales_invoice_item_id (FK → sales_invoice_items.id) - البند الأصلي
     • product_id (FK → products.id)
     • quantity (الكمية المرجعة)
     • unit_price (السعر من الفاتورة الأصلية)

3️⃣ store_actual_stock
   - ✅ خصم من مخزون المتجر الفعلي
   - الحقول المحدثة:
     • quantity = quantity - الكمية_المرجعة (لكل منتج)

4️⃣ store_return_pending_stock
   - ✅ إضافة إلى المخزون المرحلي للإرجاع
   - الحقول المستخدمة:
     • id (تلقائي)
     • return_id (FK → sales_returns.id)
     • store_id (FK → stores.id)
     • product_id (FK → products.id)
     • quantity (الكمية المرجعة)
     • created_at

📌 ملاحظة: البضاعة تنتقل من store_actual_stock → store_return_pending_stock
📌 لا يتأثر الدين في هذه المرحلة


┌─────────────────────────────────────────────────────────────────────────────┐
│ المرحلة 2: إلغاء المسوق (Cancelled) - احتمال بديل                         │
└─────────────────────────────────────────────────────────────────────────────┘

🔹 الفاعل: المسوق (Salesman/Marketer)
🔹 الشرط: يمكن الإلغاء فقط إذا كانت الحالة 'pending'

📊 الجداول المتأثرة:
--------------------

1️⃣ sales_returns
   - تحديث السجل الموجود
   - الحقول المحدثة:
     • status = 'cancelled'
     • notes (سبب الإلغاء)
     • updated_at

2️⃣ store_return_pending_stock
   - ✅ حذف السجلات المرتبطة بهذا الإرجاع
   - WHERE return_id = معرف_الإرجاع

3️⃣ store_actual_stock
   - ✅ إرجاع الكميات إلى مخزون المتجر الفعلي
   - الحقول المحدثة:
     • quantity = quantity + الكمية_المرجعة (لكل منتج)

📌 ملاحظة: البضاعة تعود من store_return_pending_stock → store_actual_stock
📌 لا يتأثر الدين


┌─────────────────────────────────────────────────────────────────────────────┐
│ المرحلة 3: رفض أمين المخزن (Rejected) - احتمال بديل                        │
└─────────────────────────────────────────────────────────────────────────────┘

🔹 الفاعل: أمين المخزن (Warehouse Keeper)
🔹 السبب: قد يكون بسبب تلف البضاعة أو عدم مطابقتها

📊 الجداول المتأثرة:
--------------------

1️⃣ sales_returns
   - تحديث السجل الموجود
   - الحقول المحدثة:
     • status = 'rejected'
     • notes (سبب الرفض)
     • updated_at

2️⃣ store_return_pending_stock
   - ✅ حذف السجلات المرتبطة بهذا الإرجاع
   - WHERE return_id = معرف_الإرجاع

3️⃣ store_actual_stock
   - ✅ إرجاع الكميات إلى مخزون المتجر الفعلي
   - الحقول المحدثة:
     • quantity = quantity + الكمية_المرجعة (لكل منتج)

📌 ملاحظة: البضاعة تعود من store_return_pending_stock → store_actual_stock
📌 لا يتأثر الدين


┌─────────────────────────────────────────────────────────────────────────────┐
│ المرحلة 4: التوثيق النهائي (Approved)                                      │
└─────────────────────────────────────────────────────────────────────────────┘

🔹 الفاعل: أمين المخزن (Warehouse Keeper)
🔹 الشرط: يجب أن تكون الحالة 'pending' ورفع الفاتورة المختومة

📊 الجداول المتأثرة:
--------------------

1️⃣ sales_returns
   - تحديث السجل الموجود
   - الحقول المحدثة:
     • status = 'approved'
     • keeper_id (FK → users.id) - أمين المخزن
     • stamped_image (صورة فاتورة الإرجاع المختومة)
     • confirmed_at (وقت التوثيق)
     • updated_at

2️⃣ store_return_pending_stock
   - ✅ حذف السجلات المرتبطة بهذا الإرجاع
   - WHERE return_id = معرف_الإرجاع

3️⃣ marketer_actual_stock
   - ✅ إضافة أو تحديث الكميات في مخزون المسوق الفعلي
   - الحقول المستخدمة:
     • id (تلقائي إذا كان سجل جديد)
     • marketer_id (FK → users.id)
     • product_id (FK → products.id)
     • quantity = quantity + الكمية_المرجعة

4️⃣ store_debt_ledger
   - ✅ تسجيل تقليل الدين
   - الحقول المستخدمة:
     • id (تلقائي)
     • store_id (FK → stores.id)
     • entry_type = 'return'
     • sales_invoice_id (NULL)
     • return_id (FK → sales_returns.id)
     • payment_id (NULL)
     • amount (قيمة البضاعة المرجعة - سالب)
     • created_at (وقت التسجيل)

📌 ملاحظة: البضاعة تنتقل من store_return_pending_stock → marketer_actual_stock
📌 الآن فقط يقل الدين
📌 ⚠️ لا تتأثر عمولات المسوق (marketer_commissions) بالإرجاع


================================================================================
                            ملخص الجداول المتأثرة
================================================================================

✅ جداول أساسية (تتأثر في كل الحالات):
   1. sales_returns
   2. sales_return_items

✅ جداول المخزون (تتأثر عند الإنشاء):
   3. store_actual_stock (خصم)
   4. store_return_pending_stock (إضافة - مرحلي)

✅ جداول المخزون (تتأثر عند التوثيق):
   5. store_return_pending_stock (حذف)
   6. marketer_actual_stock (إضافة)

✅ جداول الديون (تتأثر عند التوثيق فقط):
   7. store_debt_ledger

✅ جداول مرجعية (للقراءة فقط):
   - users (للمسوق وأمين المخزن)
   - stores (لمعلومات المتجر)
   - sales_invoices (الفاتورة الأصلية)
   - sales_invoice_items (بنود الفاتورة الأصلية)
   - products (لمعلومات المنتجات)


================================================================================
                        مخطط تدفق الحالات (Status Flow)
================================================================================

                            ┌─────────────┐
                            │   pending   │ ← إنشاء طلب الإرجاع
                            └──────┬──────┘
                                   │
                    ┌──────────────┼──────────────┐
                    │              │              │
                    ▼              ▼              ▼
              ┌──────────┐   ┌──────────┐   ┌──────────┐
              │cancelled │   │ approved │   │ rejected │
              │+ إرجاع  │   │-دين+بضاعة│   │+ إرجاع  │
              └──────────┘   └──────────┘   └──────────┘


================================================================================
                        🔄 حركة المخزون في كل مرحلة
================================================================================

📦 عند الإنشاء (pending):
   store_actual_stock ↓
   store_return_pending_stock ↑

📦 عند الإلغاء (cancelled):
   store_return_pending_stock ↓ (حذف)
   store_actual_stock ↑ (إرجاع)

📦 عند الرفض (rejected):
   store_return_pending_stock ↓ (حذف)
   store_actual_stock ↑ (إرجاع)

📦 عند التوثيق (approved):
   store_return_pending_stock ↓ (حذف)
   marketer_actual_stock ↑
   store_debt_ledger ↓ (تقليل الدين)


================================================================================
                        مخطط حركة البضاعة والدين
================================================================================

    ┌──────────────────────┐
    │  store_actual_stock  │ ← البضاعة عند المتجر
    └──────────┬───────────┘
               │
               │ (عند الإنشاء - pending)
               │
               ▼
    ┌──────────────────────────┐
    │ store_return_pending_    │ ← المخزون المرحلي للإرجاع
    │ stock                    │
    └──────────┬───────────────┘
               │
               │ (عند التوثيق - approved)
               │ (بعد رفع فاتورة الإرجاع المختومة)
               │
               ▼
    ┌──────────────────────┐
    │ marketer_actual_stock│ ← البضاعة تعود للمسوق
    └──────────────────────┘

               +

    ┌──────────────────────┐
    │  store_debt_ledger   │ ← تقليل الدين على المتجر
    │   (entry: return)    │    (amount سالب)
    └──────────────────────┘


================================================================================
                            ملاحظات مهمة
================================================================================

⚠️ قواعد العمل:
   1. ✅ لا يمكن إرجاع كمية أكبر من الكمية في الفاتورة الأصلية (sales_invoice_items)
   2. ✅ يجب رفع صورة فاتورة الإرجاع المختومة عند التوثيق
   4. ✅ البضاعة تتحرك على مرحلتين:
      - عند الإنشاء: store_actual_stock → store_return_pending_stock
      - عند التوثيق: store_return_pending_stock → marketer_actual_stock
   5. ✅ الدين لا يتأثر إلا عند التوثيق (approved)
   6. ✅ السعر المستخدم لحساب تقليل الدين هو السعر من الفاتورة الأصلية (unit_price)
   7. ✅ ⚠️ لا تتأثر عمولات المسوق بالإرجاع، العمولات تتأثر فقط بإيصالات القبض
   8. ✅ إذا تم رفض/إلغاء الإرجاع، تعود البضاعة من store_return_pending_stock → store_actual_stock
   9. ✅ الفائدة من المخزون المرحلي: إذا تم رفض الإرجاع، ترجع البضاعة للمتجر دون التأثير على الدين

🔐 الصلاحيات:
   - المسوق: إنشاء طلب الإرجاع، الإلغاء (pending فقط)
   - أمين المخزن: التوثيق النهائي، الرفض

📊 التقارير المتاحة:
   - طلبات الإرجاع حسب الحالة
   - إرجاعات المتجر
   - حركة مخزون المتجر
   - حركة مخزون المسوق
   - البضاعة المرجعة قيد المعالجة (من store_return_pending_stock)
   - تأثير الإرجاعات على الديون

💰 حساب تقليل الدين:
   - قيمة الإرجاع = مجموع (الكمية المرجعة × السعر من الفاتورة الأصلية)
   - يتم تسجيل المبلغ كـ سالب في store_debt_ledger
   - الدين الكلي للمتجر = مجموع (sale) - مجموع (return) - مجموع (payment)

🔄 الفرق بين الإرجاع والتسديد:
   - الإرجاع (return): إرجاع بضاعة، يقلل الدين ويعيد البضاعة
   - التسديد (payment): دفع نقدي، يقلل الدين فقط ويضيف عمولة للمسوق

💡 حالات الاستخدام:
   - بضاعة تالفة أو منتهية الصلاحية
   - بضاعة لم تباع في المتجر
   - خطأ في الفاتورة الأصلية
   - عدم رضا المتجر عن المنتج

📝 الفاتورة المختومة:
   - يجب أن تكون موقعة من المتجر
   - تثبت إرجاع البضاعة
   - يرفعها أمين المخزن عند التوثيق
   - تحفظ في sales_returns.stamped_image

⚠️ ملاحظة مهمة جداً:
   - العمولات في marketer_commissions لا تتأثر بالإرجاع
   - العمولات تسجل فقط عند التسديد النقدي (store_payments)
   - الإرجاع يقلل الدين فقط دون التأثير على العمولات المسجلة سابقاً
   - هذا يعني أن المسوق يحتفظ بعمولته حتى لو تم إرجاع البضاعة

🎯 أهداف النظام:
   - مرونة في التعامل مع البضاعة غير المرغوبة
   - حساب دقيق للديون بعد الإرجاعات
   - توثيق كامل لكل عملية إرجاع
   - منع النزاعات بين المسوق والمتجر
   - تتبع دقيق للبضاعة في جميع المراحل

================================================================================
