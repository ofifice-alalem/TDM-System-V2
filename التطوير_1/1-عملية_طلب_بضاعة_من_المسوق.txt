================================================================================
                    عملية: طلب بضاعة من المسوق
================================================================================

📋 نظرة عامة:
--------------
عملية طلب المسوق للبضاعة من المخزن الرئيسي تمر بعدة مراحل من الإنشاء حتى التوثيق النهائي.
✅ البضاعة تُحجز عند موافقة أمين المخزن (approved) لضمان توفرها للمسوق.

================================================================================
                        🗂️ الجداول المستخدمة
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│ 1️⃣ marketer_requests                                                        │
└─────────────────────────────────────────────────────────────────────────────┘

وظيفته:
يمثل طلب بضاعة من المسوق إلى أمين المخزن، من لحظة الإنشاء إلى التوثيق النهائي.

الحقل              النوع        العلاقة           القيمة الافتراضية    الوصف
──────────────────────────────────────────────────────────────────────────────────────
id                 BIGINT       PK               AUTO_INCREMENT        المعرف الداخلي
invoice_number     VARCHAR      UNIQUE           —                     رقم فاتورة الطلب
marketer_id        BIGINT       FK → users.id    —                     المسوق منشئ الطلب
status             ENUM         —                'pending'             pending / approved / rejected / cancelled / documented
notes              TEXT         —                NULL                  سبب الرفض أو ملاحظات الإلغاء
approved_by        BIGINT       FK → users.id    NULL                  أمين المخزن الذي وافق
approved_at        TIMESTAMP    —                NULL                  تاريخ الموافقة
rejected_by        BIGINT       FK → users.id    NULL                  أمين المخزن الذي رفض
rejected_at        TIMESTAMP    —                NULL                  تاريخ الرفض
documented_by      BIGINT       FK → users.id    NULL                  أمين المخزن الذي وثّق
documented_at      TIMESTAMP    —                NULL                  تاريخ التوثيق النهائي
stamped_image      VARCHAR      —                NULL                  صورة الفاتورة الموقعة / المختومة
created_at         TIMESTAMP    —                CURRENT_TIMESTAMP     تاريخ إنشاء الطلب
updated_at         TIMESTAMP    —                CURRENT_TIMESTAMP     آخر تغيير حالة


┌─────────────────────────────────────────────────────────────────────────────┐
│ 2️⃣ marketer_request_items                                                   │
└─────────────────────────────────────────────────────────────────────────────┘

وظيفته:
يحتوي على تفاصيل المنتجات والكميات المطلوبة في كل طلب.

الحقل              النوع        العلاقة                      الوصف
─────────────────────────────────────────────────────────────────────────────
id                 BIGINT       PK                          المعرف الداخلي
request_id         BIGINT       FK → marketer_requests.id   معرف الطلب
product_id         BIGINT       FK → products.id            معرف المنتج
quantity           INT          —                           الكمية المطلوبة


================================================================================
                        المراحل والجداول المتأثرة
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│ المرحلة 1: إنشاء الطلب (Pending)                                           │
└─────────────────────────────────────────────────────────────────────────────┘

🔹 الفاعل: المسوق (Salesman/Marketer)

📊 الجداول المتأثرة:
--------------------

1️⃣ marketer_requests
   - يتم إنشاء سجل جديد
   - الحقول المستخدمة:
     • id (تلقائي)
     • invoice_number (رقم الفاتورة)
     • marketer_id (معرف المسوق)
     • status = 'pending'
     • created_at (وقت الإنشاء)

2️⃣ marketer_request_items
   - يتم إضافة سجل لكل منتج في الطلب
   - الحقول المستخدمة:
     • id (تلقائي)
     • request_id (FK → marketer_requests.id)
     • product_id (FK → products.id)
     • quantity (الكمية المطلوبة)

📌 ملاحظة: في هذه المرحلة لا يتأثر المخزون، مجرد تسجيل الطلب


┌─────────────────────────────────────────────────────────────────────────────┐
│ المرحلة 2: موافقة أمين المخزن (Approved)                                   │
└─────────────────────────────────────────────────────────────────────────────┘

🔹 الفاعل: أمين المخزن (Warehouse Keeper)

📊 الجداول المتأثرة:
--------------------

1️⃣ marketer_requests
   - تحديث السجل الموجود
   - الحقول المحدثة:
     • status = 'approved'
     • approved_by (FK → users.id) - معرف أمين المخزن
     • approved_at (وقت الموافقة)
     • updated_at

2️⃣ main_stock
   - ✅ خصم من المخزن الرئيسي (حجز)
   - الحقول المحدثة:
     • quantity = quantity - الكمية_المطلوبة (لكل منتج)
     • updated_at (وقت التحديث)

3️⃣ marketer_reserved_stock
   - ✅ إضافة الكميات إلى المخزون المحجوز للمسوق
   - الحقول المستخدمة:
     • id (تلقائي إذا كان سجل جديد)
     • marketer_id (FK → users.id)
     • product_id (FK → products.id)
     • quantity = quantity + الكمية_المطلوبة

📌 ملاحظة: الآن يتم حجز البضاعة، أمين المخزن أصبح مسؤولاً عن توفيرها


┌─────────────────────────────────────────────────────────────────────────────┐
│ المرحلة 3: رفض أمين المخزن (Rejected) - احتمال بديل                        │
└─────────────────────────────────────────────────────────────────────────────┘

🔹 الفاعل: أمين المخزن (Warehouse Keeper)

⚠️ الرفض له حالتان:

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔴 الحالة 1: رفض من pending → rejected
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 الجداول المتأثرة:

1️⃣ marketer_requests
   - تحديث السجل الموجود
   - الحقول المحدثة:
     • status = 'rejected'
     • rejected_by (FK → users.id)
     • rejected_at
     • notes (سبب الرفض)
     • updated_at

📌 ملاحظة: لا يتأثر المخزون (لم يتم الحجز بعد)


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔴 الحالة 2: رفض من approved → rejected
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 الجداول المتأثرة:

1️⃣ marketer_requests
   - تحديث السجل الموجود
   - الحقول المحدثة:
     • status = 'rejected'
     • rejected_by (FK → users.id)
     • rejected_at
     • notes (سبب الرفض)
     • updated_at

2️⃣ main_stock
   - ✅ إرجاع تلقائي للمخزن الرئيسي
   - الحقول المحدثة:
     • quantity = quantity + الكمية_المطلوبة (لكل منتج)
     • updated_at

3️⃣ marketer_reserved_stock
   - ✅ خصم من المخزون المحجوز للمسوق
   - الحقول المحدثة:
     • quantity = quantity - الكمية_المطلوبة

📌 ملاحظة: يتم إرجاع البضاعة تلقائياً من المحجوز إلى المخزن الرئيسي


┌─────────────────────────────────────────────────────────────────────────────┐
│ المرحلة 4: إلغاء المسوق (Cancelled) - احتمال بديل                          │
└─────────────────────────────────────────────────────────────────────────────┘

🔹 الفاعل: المسوق (Salesman/Marketer)

⚠️ الإلغاء له حالتان:

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🟡 الحالة 1: إلغاء من pending → cancelled
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 الجداول المتأثرة:

1️⃣ marketer_requests
   - تحديث السجل الموجود
   - الحقول المحدثة:
     • status = 'cancelled'
     • notes (سبب الإلغاء)
     • updated_at

📌 ملاحظة: لا يتأثر المخزون (لم يتم الحجز بعد)


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🟡 الحالة 2: إلغاء من approved → cancelled
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 الجداول المتأثرة:

1️⃣ marketer_requests
   - تحديث السجل الموجود
   - الحقول المحدثة:
     • status = 'cancelled'
     • notes (سبب الإلغاء)
     • updated_at

2️⃣ main_stock
   - ✅ إرجاع تلقائي للمخزن الرئيسي
   - الحقول المحدثة:
     • quantity = quantity + الكمية_المطلوبة (لكل منتج)
     • updated_at

3️⃣ marketer_reserved_stock
   - ✅ خصم من المخزون المحجوز للمسوق
   - الحقول المحدثة:
     • quantity = quantity - الكمية_المطلوبة

📌 ملاحظة: يتم إرجاع البضاعة تلقائياً من المحجوز إلى المخزن الرئيسي


┌─────────────────────────────────────────────────────────────────────────────┐
│ المرحلة 5: توقيع المسوق واستلام البضاعة (Documented)                       │
└─────────────────────────────────────────────────────────────────────────────┘

🔹 الفاعل: المسوق (Salesman/Marketer) + أمين المخزن (Warehouse Keeper)
🔹 الشرط: يجب أن تكون الحالة 'approved'

📊 الجداول المتأثرة:
--------------------

1️⃣ marketer_requests
   - تحديث السجل الموجود
   - الحقول المحدثة:
     • status = 'documented'
     • documented_by (FK → users.id) - أمين المخزن
     • documented_at (وقت التوثيق)
     • stamped_image (صورة الفاتورة الموقعة)
     • updated_at

2️⃣ marketer_reserved_stock
   - ✅ خصم من المخزون المحجوز
   - الحقول المحدثة:
     • quantity = quantity - الكمية_المطلوبة

3️⃣ marketer_actual_stock
   - ✅ إضافة إلى المخزون الفعلي للمسوق
   - الحقول المستخدمة:
     • id (تلقائي إذا كان سجل جديد)
     • marketer_id (FK → users.id)
     • product_id (FK → products.id)
     • quantity = quantity + الكمية_المطلوبة

4️⃣ warehouse_stock_logs
   - تسجيل حركة المخزن
   - الحقول المستخدمة:
     • id (تلقائي)
     • invoice_type = 'marketer_request'
     • invoice_id (معرف الطلب)
     • keeper_id (FK → users.id)
     • action = 'withdraw'
     • created_at

📌 ملاحظة: البضاعة تنتقل من المحجوز إلى الفعلي بعد رفع الفاتورة الموقعة


================================================================================
                            ملخص الجداول المتأثرة
================================================================================

✅ جداول أساسية (تتأثر في كل الحالات):
   1. marketer_requests
   2. marketer_request_items

✅ جداول المخزون (تتأثر حسب المرحلة):
   3. main_stock (عند الإنشاء، الرفض، الإلغاء)
   4. marketer_reserved_stock (عند الإنشاء، الرفض، الإلغاء، التوثيق)
   5. marketer_actual_stock (عند التوثيق فقط)
   6. warehouse_stock_logs (عند التوثيق فقط)

✅ جداول مرجعية (للقراءة فقط):
   - users (للمسوق وأمين المخزن)
   - products (لمعلومات المنتجات)


================================================================================
                        مخطط تدفق الحالات (Status Flow)
================================================================================

                            ┌─────────────┐
                            │   pending   │ ← إنشاء الطلب (بدون حجز)
                            └──────┬──────┘
                                   │
                    ┌──────────────┼──────────────┐
                    │              │              │
                    ▼              ▼              ▼
              ┌──────────┐   ┌──────────┐   ┌──────────┐
              │cancelled │   │ approved │   │ rejected │
              │          │   │+ حجز     │   │          │
              └──────────┘   └─────┬────┘   └──────────┘
                                   │
           ┌───────────────────────┬─────────────────────┐
           │                       │                     │
           ▼                       ▼                     ▼
    ┌─────────────┐        ┌─────────────┐          ┌──────────┐
    │  rejected   │        │ documented  │          │cancelled │
    │  + إرجاع    │          │ محجوز→فعلي │         │ + إرجاع │
    └─────────────┘        └─────────────┘          └──────────┘


================================================================================
                        🔄 حركة المخزون في كل مرحلة
================================================================================

📦 عند الإنشاء (pending):
   لا تغيير في المخزون

📦 عند الموافقة (approved):
   main_stock ↓
   marketer_reserved_stock ↑

📦 عند الرفض (rejected):
   - إذا من pending: لا تغيير في المخزون
   - إذا من approved: main_stock ↑ / marketer_reserved_stock ↓

📦 عند الإلغاء (cancelled):
   - إذا من pending: لا تغيير في المخزون
   - إذا من approved: main_stock ↑ / marketer_reserved_stock ↓

📦 عند التوثيق (documented):
   marketer_reserved_stock ↓
   marketer_actual_stock ↑


================================================================================
                            ملاحظات مهمة
================================================================================

⚠️ قواعد العمل:
   1. ✅ البضاعة تُحجز عند الموافقة (approved) وليس عند الإنشاء
   2. ✅ لا يمكن الموافقة إذا كانت الكمية غير متوفرة في main_stock
   3. ✅ لا يمكن إلغاء الطلب بعد التوثيق (documented)
   4. ✅ يجب رفع صورة الفاتورة الموقعة عند التوثيق
   5. ✅ عند الرفض/الإلغاء من approved: إرجاع تلقائي للمخزن الرئيسي
   6. ✅ عند الرفض/الإلغاء من pending: لا يتأثر المخزون (لم يتم الحجز)
   6. ✅ البضاعة تنتقل من محجوز → فعلي عند التوثيق
   7. ✅ أمين المخزن مسؤول عن توفير البضاعة بعد الموافقة

🔐 الصلاحيات:
   - المسوق: إنشاء الطلب، الإلغاء (pending أو approved)
   - أمين المخزن: الموافقة، الرفض، التوثيق النهائي

📊 التقارير المتاحة:
   - طلبات المسوق حسب الحالة
   - حركة المخزون الرئيسي
   - مخزون المسوق (محجوز + فعلي)
   - سجل التوثيقات

🎯 الفائدة من الحجز عند الموافقة:
   - ✅ أمين المخزن يتحقق من التوفر قبل الموافقة
   - ✅ لا حجز بدون مسؤولية
   - ✅ المخزن الرئيسي يعكس المتاح فعلياً بعد الموافقة
   - ✅ أمين المخزن مسؤول عن ضمان توفر البضاعة للمسوق

================================================================================
