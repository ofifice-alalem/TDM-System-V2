================================================================================
                    عملية: إيصال القبض (تسديد دين المتجر)
================================================================================

📋 نظرة عامة:
--------------
عملية تسديد المتجر لديونه تمر بمرحلتين: إنشاء إيصال القبض ثم التوثيق النهائي.
✅ الدين يُخصم فقط عند التوثيق النهائي.
✅ العمولة تُسجل للمسوق عند التوثيق.

================================================================================
                        🗂️ الجداول المستخدمة
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│ 1️⃣ store_payments                                                           │
└─────────────────────────────────────────────────────────────────────────────┘

وظيفته:
يمثل إيصال قبض (تسديد) من المتجر، من لحظة الإنشاء إلى التوثيق النهائي.

الحقل                النوع        العلاقة           القيمة الافتراضية    الوصف
────────────────────────────────────────────────────────────────────────────────────────
id                   BIGINT       PK               AUTO_INCREMENT        المعرف الداخلي
payment_number       VARCHAR      UNIQUE           —                     رقم إيصال القبض
store_id             BIGINT       FK → stores.id   —                     المتجر المسدد
marketer_id          BIGINT       FK → users.id    —                     المسوق المستلم
keeper_id            BIGINT       FK → users.id    —                     أمين المخزن
amount               DECIMAL      —                —                     المبلغ المسدد
payment_method       ENUM         —                —                     cash / transfer / certified_check
status               ENUM         —                'pending'             pending / approved / rejected / cancelled
receipt_image        VARCHAR      —                NULL                  صورة إيصال القبض المختوم
confirmed_at         TIMESTAMP    —                NULL                  تاريخ التوثيق
notes                TEXT         —                NULL                  ملاحظات (سبب الرفض أو الإلغاء)
created_at           TIMESTAMP    —                CURRENT_TIMESTAMP     تاريخ الإنشاء


================================================================================
                        المراحل والجداول المتأثرة
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│ المرحلة 1: إنشاء إيصال القبض (Pending)                                     │
└─────────────────────────────────────────────────────────────────────────────┘

🔹 الفاعل: المسوق (Salesman/Marketer)
🔹 الشرط: يجب أن يكون هناك دين على المتجر

📊 الجداول المتأثرة:
--------------------

1️⃣ store_payments
   - يتم إنشاء سجل جديد
   - الحقول المستخدمة:
     • id (تلقائي)
     • payment_number (رقم إيصال القبض)
     • store_id (معرف المتجر)
     • marketer_id (معرف المسوق)
     • keeper_id (أمين المخزن)
     • amount (المبلغ المسدد)
     • payment_method (طريقة الدفع)
     • status = 'pending'
     • created_at (وقت الإنشاء)

📌 ملاحظة: في هذه المرحلة لا يتأثر الدين


┌─────────────────────────────────────────────────────────────────────────────┐
│ المرحلة 2: إلغاء الإيصال (Cancelled) - احتمال بديل                         │
└─────────────────────────────────────────────────────────────────────────────┘

🔹 الفاعل: المسوق (Salesman/Marketer)
🔹 الشرط: يمكن الإلغاء فقط إذا كانت الحالة 'pending'

📊 الجداول المتأثرة:
--------------------

1️⃣ store_payments
   - تحديث السجل الموجود
   - الحقول المحدثة:
     • status = 'cancelled'
     • notes (سبب الإلغاء)

📌 ملاحظة: لا يتأثر الدين


┌─────────────────────────────────────────────────────────────────────────────┐
│ المرحلة 3: رفض أمين المخزن (Rejected) - احتمال بديل                        │
└─────────────────────────────────────────────────────────────────────────────┘

🔹 الفاعل: أمين المخزن (Warehouse Keeper)
🔹 السبب: خطأ في المبلغ أو صورة الإيصال غير واضحة

📊 الجداول المتأثرة:
--------------------

1️⃣ store_payments
   - تحديث السجل الموجود
   - الحقول المحدثة:
     • status = 'rejected'
     • notes (سبب الرفض)

📌 ملاحظة: لا يتأثر الدين


┌─────────────────────────────────────────────────────────────────────────────┐
│ المرحلة 4: التوثيق النهائي (Approved)                                      │
└─────────────────────────────────────────────────────────────────────────────┘

🔹 الفاعل: أمين المخزن (Warehouse Keeper)
🔹 الشرط: يجب أن تكون الحالة 'pending' ورفع صورة إيصال القبض المختوم

📊 الجداول المتأثرة:
--------------------

1️⃣ store_payments
   - تحديث السجل الموجود
   - الحقول المحدثة:
     • status = 'approved'
     • receipt_image (صورة إيصال القبض المختوم)
     • confirmed_at (وقت التوثيق)

2️⃣ store_debt_ledger
   - ✅ تسجيل خصم الدين
   - الحقول المستخدمة:
     • id (تلقائي)
     • store_id (FK → stores.id)
     • entry_type = 'payment'
     • sales_invoice_id (NULL)
     • return_id (NULL)
     • payment_id (FK → store_payments.id)
     • amount (المبلغ المسدد - سالب)
     • created_at

3️⃣ marketer_commissions
   - ✅ تسجيل عمولة المسوق (إذا كان هناك نسبة عمولة)
   - الحقول المستخدمة:
     • id (تلقائي)
     • marketer_id (FK → users.id)
     • store_id (FK → stores.id)
     • keeper_id (FK → users.id)
     • payment_amount (المبلغ المسدد)
     • payment_id (FK → store_payments.id)
     • commission_rate (نسبة العمولة من users.commission_rate)
     • commission_amount (المبلغ × نسبة العمولة)
     • created_at

📌 ملاحظة: الآن فقط يُخصم المبلغ من الدين وتُسجل العمولة


================================================================================
                            ملخص الجداول المتأثرة
================================================================================

✅ جداول أساسية (تتأثر في كل الحالات):
   1. store_payments

✅ جداول الديون (تتأثر عند التوثيق فقط):
   2. store_debt_ledger

✅ جداول العمولات (تتأثر عند التوثيق فقط):
   3. marketer_commissions

✅ جداول مرجعية (للقراءة فقط):
   - users (للمسوق وأمين المخزن ونسبة العمولة)
   - stores (لمعلومات المتجر)


================================================================================
                        مخطط تدفق الحالات (Status Flow)
================================================================================

                            ┌─────────────┐
                            │   pending   │ ← إنشاء إيصال القبض
                            └──────┬──────┘
                                   │
                    ┌──────────────┼──────────────┐
                    │              │              │
                    ▼              ▼              ▼
              ┌──────────┐   ┌──────────┐   ┌──────────┐
              │cancelled │   │ approved │   │ rejected │
              │          │   │-دين+عمولة│   │          │
              └──────────┘   └──────────┘   └──────────┘


================================================================================
                        مخطط حركة الأموال
================================================================================

    ┌──────────────────────┐
    │   store_debt_ledger  │ ← الدين الحالي للمتجر
    └──────────┬───────────┘
               │
               │ (عند التوثيق - approved)
               │ (بعد رفع إيصال القبض المختوم)
               │
               ▼
    ┌──────────────────────┐
    │   store_debt_ledger  │ ← خصم المبلغ من الدين
    │   (entry: payment)   │    (amount سالب)
    └──────────────────────┘

               +

    ┌──────────────────────┐
    │ marketer_commissions │ ← تسجيل عمولة المسوق
    └──────────────────────┘


================================================================================
                            ملاحظات مهمة
================================================================================

⚠️ قواعد العمل:
   1. ✅ لا يمكن التسديد بمبلغ أكبر من الدين الحالي للمتجر
   2. ✅ يمكن إلغاء الإيصال فقط في حالة pending
   3. ✅ يجب رفع صورة إيصال القبض المختوم عند التوثيق
   4. ✅ الدين لا يتأثر إلا عند التوثيق (approved)
   5. ✅ العمولة تُحسب بناءً على نسبة المسوق (users.commission_rate)
   6. ✅ العمولة تُسجل فقط عند التوثيق
   7. ✅ طرق الدفع: نقدي (cash)، تحويل (transfer)، شيك مصدق (certified_check)

🔐 الصلاحيات:
   - المسوق: إنشاء إيصال القبض، الإلغاء (pending فقط)
   - أمين المخزن: التوثيق النهائي، الرفض

📊 التقارير المتاحة:
   - إيصالات القبض حسب الحالة
   - تسديدات المتجر
   - عمولات المسوق
   - حركة الديون

💰 حساب الدين:
   - الدين الكلي للمتجر = مجموع (sale) - مجموع (return) - مجموع (payment)
   - كل تسديد يُخصم من الدين الكلي
   - التسديد لا يرتبط بفاتورة محددة، بل بالدين الكلي

💵 حساب العمولة:
   - العمولة = المبلغ المسدد × نسبة العمولة
   - نسبة العمولة تُؤخذ من users.commission_rate للمسوق
   - إذا كانت نسبة العمولة = 0، لا تُسجل عمولة
   - العمولة تُسجل لكل تسديد موثق

🔄 الفرق بين التسديد والإرجاع:
   - التسديد (payment): دفع نقدي، يُخصم من الدين فقط
   - الإرجاع (return): إرجاع بضاعة، يُخصم من الدين ويُعيد البضاعة

📝 طرق الدفع:
   - cash: نقدي (تسليم نقود)
   - transfer: تحويل بنكي
   - certified_check: شيك مصدق (مضمون من البنك)

================================================================================
